<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico Kuyay</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #00ff00;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 { color: #ffaa00; text-align: center; }
    .section {
      background: #1a1a1a;
      border: 2px solid #333;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
    }
    .section h2 {
      color: #00aaff;
      margin-top: 0;
    }
    .success { color: #00ff00; }
    .error { color: #ff0000; }
    .warning { color: #ffaa00; }
    .info { color: #00aaff; }
    button {
      background: #00aaff;
      color: #000;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      display: block;
      margin: 20px auto;
    }
    button:hover {
      background: #0088cc;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .loading {
      text-align: center;
      color: #ffaa00;
    }
    pre {
      background: #000;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .badge-success { background: #00ff00; color: #000; }
    .badge-error { background: #ff0000; color: #fff; }
    .badge-warning { background: #ffaa00; color: #000; }
  </style>
</head>
<body>
  <h1>üîç Diagn√≥stico Completo de Kuyay</h1>

  <div class="section">
    <h2>üìã Informaci√≥n General</h2>
    <p>Este script verificar√° TODOS los aspectos de tu wallet y el contrato del c√≠rculo.</p>
    <p class="info">Direcci√≥n del C√≠rculo: <strong>0x796721cf7Eb0F064682d97b994251B2291c791A4</strong></p>
  </div>

  <button id="startBtn" onclick="runDiagnostics()">üöÄ Iniciar Diagn√≥stico</button>

  <div id="results"></div>

  <script>
    const CIRCLE_ADDRESS = "0x796721cf7Eb0F064682d97b994251B2291c791A4";
    const USDC_ADDRESS = "0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d";
    const RPC_URL = "https://sepolia-rollup.arbitrum.io/rpc";

    const CIRCLE_ABI = [
      "function getCircleState() view returns (uint8 mode, uint8 status, uint256 currentRound, uint256 pot)",
      "function hasPaidRound(address member, uint256 round) view returns (bool)",
      "function guarantees(address member) view returns (uint256)",
      "function cuotaAmount() view returns (uint256)",
      "function guaranteeAmount() view returns (uint256)",
      "function totalRounds() view returns (uint256)",
      "function getMembers() view returns (address[])",
      "function isMemberPresent(address member) view returns (bool)",
      "function getPresentMembers() view returns (address[])",
      "function canStartDraw() view returns (bool)"
    ];

    const USDC_ABI = [
      "function balanceOf(address account) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];

    let provider;
    let userAddress;

    async function log(section, message, type = 'info') {
      const resultsDiv = document.getElementById('results');
      const color = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
      resultsDiv.innerHTML += `<div class="section"><h2>${section}</h2><p class="${color}">${message}</p></div>`;
      console.log(`[${section}] ${message}`);
    }

    async function runDiagnostics() {
      document.getElementById('startBtn').disabled = true;
      document.getElementById('results').innerHTML = '<div class="loading">‚è≥ Ejecutando diagn√≥stico...</div>';

      try {
        // 1. Verificar MetaMask
        await log("1Ô∏è‚É£ Detectar MetaMask", "Buscando MetaMask...");

        if (typeof window.ethereum === 'undefined') {
          await log("1Ô∏è‚É£ Detectar MetaMask", "‚ùå ERROR: MetaMask no est√° instalado<br><br>Por favor instala MetaMask desde: <a href='https://metamask.io' target='_blank' style='color: #00aaff;'>https://metamask.io</a>", "error");
          document.getElementById('startBtn').disabled = false;
          return;
        }

        await log("1Ô∏è‚É£ Detectar MetaMask", "‚úÖ MetaMask detectado", "success");

        // 2. Solicitar Conexi√≥n
        await log("2Ô∏è‚É£ Conectar Wallet", "Solicitando conexi√≥n a MetaMask...<br><span class='warning'>‚ö†Ô∏è Por favor acepta la conexi√≥n en MetaMask</span>");

        let accounts;
        try {
          accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        } catch (error) {
          if (error.code === 4001) {
            await log("2Ô∏è‚É£ Conectar Wallet", "‚ùå ERROR: Rechazaste la conexi√≥n en MetaMask<br>Por favor vuelve a intentar y acepta la conexi√≥n", "error");
          } else {
            await log("2Ô∏è‚É£ Conectar Wallet", `‚ùå ERROR: ${error.message}`, "error");
          }
          document.getElementById('startBtn').disabled = false;
          return;
        }

        if (!accounts || accounts.length === 0) {
          await log("2Ô∏è‚É£ Conectar Wallet", "‚ùå ERROR: No se pudo obtener ninguna cuenta de MetaMask", "error");
          document.getElementById('startBtn').disabled = false;
          return;
        }

        userAddress = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum);
        const network = await provider.getNetwork();

        await log("2Ô∏è‚É£ Conectar Wallet", `‚úÖ Conectado exitosamente!<br>Direcci√≥n: <strong>${userAddress}</strong><br>Red: ${network.name} (chainId: ${network.chainId})`, "success");

        // 3. Verificar Red
        if (network.chainId !== 421614) {
          await log("3Ô∏è‚É£ Verificar Red", `‚ùå ERROR: Est√°s en la red incorrecta (chainId: ${network.chainId})<br>Debes estar en Arbitrum Sepolia (chainId: 421614)<br><br><span class='warning'>Cambia la red en MetaMask a "Arbitrum Sepolia"</span>`, "error");
          document.getElementById('startBtn').disabled = false;
          return;
        } else {
          await log("3Ô∏è‚É£ Verificar Red", "‚úÖ Red correcta: Arbitrum Sepolia", "success");
        }

        // 4. Verificar Balance de ETH
        const ethBalance = await provider.getBalance(userAddress);
        const ethBalanceFormatted = ethers.utils.formatEther(ethBalance);
        await log("4Ô∏è‚É£ Balance de ETH", `Balance: <strong>${ethBalanceFormatted} ETH</strong><br>${ethBalanceFormatted > 0.001 ? '‚úÖ' : '‚ö†Ô∏è'} ${ethBalanceFormatted > 0.001 ? 'Suficiente para gas' : 'Bajo, pero puede funcionar'}`, ethBalanceFormatted > 0.001 ? "success" : "warning");

        // 5. Verificar Balance de USDC
        const usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, provider);
        const usdcBalance = await usdcContract.balanceOf(userAddress);
        const usdcBalanceFormatted = ethers.utils.formatUnits(usdcBalance, 6);
        await log("5Ô∏è‚É£ Balance de USDC", `Balance: <strong>${usdcBalanceFormatted} USDC</strong><br>${usdcBalanceFormatted > 0 ? '‚úÖ' : '‚ùå'} ${usdcBalanceFormatted > 0 ? 'Tienes USDC' : 'NO tienes USDC'}`, usdcBalanceFormatted > 0 ? "success" : "error");

        // 6. Verificar Allowance de USDC
        const allowance = await usdcContract.allowance(userAddress, CIRCLE_ADDRESS);
        const allowanceFormatted = ethers.utils.formatUnits(allowance, 6);
        await log("6Ô∏è‚É£ Allowance de USDC", `Allowance: <strong>${allowanceFormatted} USDC</strong><br>${allowanceFormatted > 0 ? '‚úÖ' : '‚ö†Ô∏è'} ${allowanceFormatted > 0 ? 'Aprobado para el c√≠rculo' : 'NO aprobado (pero se aprueba autom√°ticamente)'}`, allowanceFormatted > 0 ? "success" : "warning");

        // 7. Verificar Estado del C√≠rculo
        const circleContract = new ethers.Contract(CIRCLE_ADDRESS, CIRCLE_ABI, provider);
        const circleState = await circleContract.getCircleState();
        const [mode, status, currentRound, pot] = circleState;

        const statusNames = ["DEPOSIT", "ACTIVE", "COMPLETED"];
        const modeNames = ["SAVINGS", "CREDIT"];

        await log("7Ô∏è‚É£ Estado del C√≠rculo", `
          Modo: <strong>${modeNames[mode]}</strong><br>
          Estado: <span class="badge badge-${status === 1 ? 'success' : status === 0 ? 'warning' : 'error'}">${statusNames[status]}</span><br>
          Ronda Actual: <strong>${currentRound.toString()}</strong><br>
          Pozo: <strong>${ethers.utils.formatUnits(pot, 6)} USDC</strong><br><br>
          ${status === 1 ? '‚úÖ C√≠rculo ACTIVO - Puedes hacer pagos' : status === 0 ? '‚ö†Ô∏è C√≠rculo en DEPOSIT - Solo dep√≥sito de garant√≠as' : '‚ùå C√≠rculo COMPLETADO'}
        `, status === 1 ? "success" : "warning");

        // 8. Verificar Garant√≠a Depositada
        const guarantee = await circleContract.guarantees(userAddress);
        const guaranteeFormatted = ethers.utils.formatUnits(guarantee, 6);
        const guaranteeRequired = await circleContract.guaranteeAmount();
        const guaranteeRequiredFormatted = ethers.utils.formatUnits(guaranteeRequired, 6);

        await log("8Ô∏è‚É£ Garant√≠a", `
          Tu garant√≠a depositada: <strong>${guaranteeFormatted} USDC</strong><br>
          Garant√≠a requerida: <strong>${guaranteeRequiredFormatted} USDC</strong><br><br>
          ${guaranteeFormatted > 0 ? '‚úÖ YA DEPOSITASTE TU GARANT√çA' : '<span class="error">‚ùå NO HAS DEPOSITADO TU GARANT√çA</span><br><span class="error">üö® ESTE ES PROBABLEMENTE TU PROBLEMA</span>'}
        `, guaranteeFormatted > 0 ? "success" : "error");

        // 9. Verificar Si Ya Pag√≥ Esta Ronda
        let hasPaid = false;
        if (currentRound.toNumber() > 0) {
          hasPaid = await circleContract.hasPaidRound(userAddress, currentRound);
          await log("9Ô∏è‚É£ Estado de Pago Ronda " + currentRound, `
            ${hasPaid ? '<span class="error">‚úÖ YA PAGASTE esta ronda</span>' : '‚ùå NO has pagado esta ronda'}<br><br>
            ${hasPaid ? '<span class="error">‚ö†Ô∏è NO PUEDES VOLVER A PAGAR LA MISMA RONDA</span><br><span class="error">üö® ESTE PUEDE SER TU PROBLEMA</span>' : '<span class="success">‚úÖ Puedes proceder con el pago</span>'}
          `, hasPaid ? "warning" : "success");

          // 10. Verificar Cuota
          const cuotaAmount = await circleContract.cuotaAmount();
          const cuotaFormatted = ethers.utils.formatUnits(cuotaAmount, 6);
          await log("üîü Cuota de la Ronda", `
            Cuota mensual: <strong>${cuotaFormatted} USDC</strong><br>
            Tu balance: <strong>${usdcBalanceFormatted} USDC</strong><br><br>
            ${parseFloat(usdcBalanceFormatted) >= parseFloat(cuotaFormatted) ? '‚úÖ Tienes suficiente USDC' : '‚ùå NO tienes suficiente USDC'}
          `, parseFloat(usdcBalanceFormatted) >= parseFloat(cuotaFormatted) ? "success" : "error");
        } else {
          await log("9Ô∏è‚É£ Estado de Pago", "‚ö†Ô∏è El c√≠rculo no ha iniciado rondas a√∫n (currentRound = 0)", "warning");
        }

        // 11. Verificar Miembros
        const members = await circleContract.getMembers();
        await log("1Ô∏è‚É£1Ô∏è‚É£ Miembros del C√≠rculo", `
          Total: <strong>${members.length} miembros</strong><br>
          ¬øEres miembro? ${members.map(m => m.toLowerCase()).includes(userAddress.toLowerCase()) ? '‚úÖ S√ç' : '‚ùå NO'}
        `, "info");

        // 12. Verificar Presencia para Sorteo
        if (status === 1 && currentRound.toNumber() > 0) {
          const isPresent = await circleContract.isMemberPresent(userAddress);
          const presentMembers = await circleContract.getPresentMembers();
          const canStartDraw = await circleContract.canStartDraw();

          await log("1Ô∏è‚É£2Ô∏è‚É£ Estado del Sorteo", `
            ¬øMarcaste presencia? ${isPresent ? '‚úÖ S√ç' : '‚ùå NO'}<br>
            Miembros presentes: ${presentMembers.length}/${members.length}<br>
            ¬øPuede iniciar sorteo? ${canStartDraw ? '‚úÖ S√ç' : '‚ùå NO'}
          `, "info");
        }

        // RESUMEN FINAL
        await log("üéØ DIAGN√ìSTICO FINAL", `
          <strong>AN√ÅLISIS DEL ERROR:</strong><br><br>
          ${guaranteeFormatted == 0 ?
            'üö® <span class="error">PROBLEMA PRINCIPAL: NO HAS DEPOSITADO TU GARANT√çA</span><br>Debes depositar $' + guaranteeRequiredFormatted + ' USDC como garant√≠a ANTES de poder hacer pagos.<br><br>' :
            ''
          }
          ${status === 0 ?
            'üö® <span class="error">PROBLEMA: El c√≠rculo est√° en fase DEPOSIT</span><br>No puedes hacer pagos hasta que todos depositen garant√≠as y el c√≠rculo se active.<br><br>' :
            ''
          }
          ${currentRound.toNumber() === 0 ?
            'üö® <span class="error">PROBLEMA: El c√≠rculo no ha iniciado rondas</span><br>El c√≠rculo a√∫n no est√° operativo (currentRound = 0).<br><br>' :
            ''
          }
          <strong>PASOS A SEGUIR:</strong><br>
          ${guaranteeFormatted == 0 ?
            '1Ô∏è‚É£ DEPOSITA TU GARANT√çA ($' + guaranteeRequiredFormatted + ' USDC)<br>' :
            '1Ô∏è‚É£ ‚úÖ Garant√≠a depositada<br>'
          }
          ${status === 0 ?
            '2Ô∏è‚É£ Espera a que todos los miembros depositen garant√≠as<br>' :
            status === 1 ? '2Ô∏è‚É£ ‚úÖ C√≠rculo activo<br>' : '2Ô∏è‚É£ ‚ùå C√≠rculo completado<br>'
          }
          ${currentRound.toNumber() > 0 ?
            '3Ô∏è‚É£ ${hasPaid ? "‚ùå YA PAGASTE - Espera siguiente ronda" : "‚úÖ Puedes hacer pago"}<br>' :
            '3Ô∏è‚É£ Espera a que inicie la primera ronda<br>'
          }
        `, "info");

      } catch (error) {
        await log("‚ùå ERROR CR√çTICO", `
          <span class="error">${error.message}</span><br><br>
          <pre>${error.stack}</pre>
        `, "error");
      }

      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = "üîÑ Ejecutar de Nuevo";
    }
  </script>
</body>
</html>
